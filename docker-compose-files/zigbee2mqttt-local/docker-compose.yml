version: "3.8"
services:
  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    container_name: zigbee2mqtt-local
    environment:
      - PUID=1
      - PGID=1
      - TZ=${DOCKER_TZ}
      - MQTT_HOST=${MQTT_HOST}
      - MQTT_PORT=${MQTT_PORT:-1883}
    volumes:
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/data:/app/data
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/run/udev:/run/udev:ro
    ports:
      # Frontend port
      - 8080:8080
    restart: unless-stopped
    devices:
      # Make sure this matched your adapter location
      #- /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00:/dev/ttyUSB0
      - ${DOCKER_DONGLE:-/dev/ttyUSB0}:/dev/ttyUSB0
    group_add:
      - dialout
    user: 0:0
    healthcheck:
      #test: "nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null || exit 1"
      #test: ["CMD-SHELL", "sh -c 'nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null >/dev/null 2>&1 || exit 1'"]
      test: ["CMD-SHELL", "wget -qO- http://$(hostname -i):8080 || exit 1"]
      #test: ["CMD-SHELL", "! grep -q 'MQTT error: connect ECONNREFUSED' /app/data/log/zigbee2mqtt.log || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 1
    deploy:
      replicas: 1
      restart_policy:
        condition: any
    labels:
      - autoheal=true


  watchdog:
    image: docker:cli
    container_name: zigbee2mqtt-watchdog
    command: >
      sh -c '
        echo "🔍 Watchdog iniciado para contenedor: zigbee2mqtt-local";
        while true; do
          docker logs --since 10s zigbee2mqtt-local 2>&1 | grep "MQTT error: connect ECONNREFUSED" >/dev/null && {
            echo "$(date): ⚠️  Error MQTT detectado — reiniciando zigbee2mqtt-local...";
            docker restart zigbee2mqtt-local >/dev/null 2>&1;
            echo "$(date): 🌀 Reinicio ejecutado correctamente. Esperando 60 segundos antes de reanudar...";
            sleep 60;
          };
          sleep 5;
        done
      '
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped















