version: "3.8"
services:
  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    container_name: zigbee2mqtt-local
    environment:
      - PUID=1
      - PGID=1
      - TZ=${DOCKER_TZ}
      - MQTT_HOST=${MQTT_HOST}
      - MQTT_PORT=${MQTT_PORT:-1883}
    volumes:
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/data:/app/data
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/run/udev:/run/udev:ro
    ports:
      # Frontend port
      - 8080:8080
    restart: unless-stopped
    devices:
      # Make sure this matched your adapter location
      #- /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00:/dev/ttyUSB0
      - ${DOCKER_DONGLE:-/dev/ttyUSB0}:/dev/ttyUSB0
    group_add:
      - dialout
    user: 0:0
    healthcheck:
      #test: "nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null || exit 1"
      test: ["CMD-SHELL", "sh -c 'nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null >/dev/null 2>&1 || exit 1'"]
      #test: ["CMD-SHELL", "wget -qO- http://localhost:8080/api/health | grep -q '\"mqtt\":true'"]
      #test: ["CMD-SHELL", "! grep -q 'MQTT error: connect ECONNREFUSED' /app/data/log/zigbee2mqtt.log || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 1
    deploy:
      replicas: 1
      restart_policy:
        condition: any
    labels:
      - autoheal=true
  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  watchdog:
    image: alpine:3.20
    container_name: zigbee2mqtt-watchdog
    command: >
      sh -c '
        echo "🔍 Monitorizando logs de zigbee2mqtt...";
        while true; do
          docker logs -f zigbee2mqtt-local 2>&1 |
          while read -r line; do
            echo "$line" | grep -q "MQTT error: connect ECONNREFUSED" && {
              echo "$(date): error MQTT detectado, reiniciando contenedor...";
              docker restart zigbee2mqtt-local >/dev/null 2>&1;
              sleep 60;  # espera para evitar reinicios en bucle
              break;
            };
          done;
          sleep 5;
        done
      '
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    deploy:
      mode: global
      restart_policy:
        condition: on-failure









