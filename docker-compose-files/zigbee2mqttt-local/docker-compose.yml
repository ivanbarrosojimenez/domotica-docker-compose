version: "3.8"
services:
  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    container_name: zigbee2mqtt-local
    environment:
      - PUID=1
      - PGID=1
      - TZ=${DOCKER_TZ}
      - MQTT_HOST=${MQTT_HOST}
      - MQTT_PORT=${MQTT_PORT:-1883}
    volumes:
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/data:/app/data
      - ${DOCKER_PATH_PERSISTENT}/zigbee2mqtt/run/udev:/run/udev:ro
    ports:
      # Frontend port
      - 8080:8080
    restart: unless-stopped
    devices:
      # Make sure this matched your adapter location
      #- /dev/serial/by-id/usb-Silicon_Labs_Sonoff_Zigbee_3.0_USB_Dongle_Plus_0001-if00:/dev/ttyUSB0
      - ${DOCKER_DONGLE:-/dev/ttyUSB0}:/dev/ttyUSB0
    group_add:
      - dialout
    user: 0:0
    healthcheck:
      #test: "nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null || exit 1"
      #test: ["CMD-SHELL", "sh -c 'nc -w3 $${MQTT_HOST} $${MQTT_PORT} < /dev/null >/dev/null 2>&1 || exit 1'"]
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/api/health | grep -q '\"mqtt\":true'"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      replicas: 1
      restart_policy:
        condition: any
    labels:
      - autoheal=true   # ðŸ‘ˆ Necesario para que autoheal lo vigile

  autoheal:
    image: willfarrell/autoheal
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_CONTAINER_LABEL=all
      - AUTOHEAL_INTERVAL=30
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock







